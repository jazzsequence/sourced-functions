#
# Creates a _misc directory for various project assets in the main project folder.
# Forked from https://github.com/bradp/dotfiles
#
function proj() {
	project="${PWD##*/}"

	echo "Setting up new project folder / file structure for $project..."
	echo "Making misc dirs..."

	mkdir -p "_misc/assets"
	mkdir -p "_misc/backups"
	mkdir -p "_misc/notes"
	mkdir -p "_misc/sublime"

	echo "Creating sublime project file..."
	sproj
	mv "$project".sublime-project _misc/sublime/"$project".sublime-project

	echo "Done!"

}

#
# Creates a sublime-project file.
# Forked from https://github.com/bradp/dotfiles to work with MAMP.
#
function sproj() {

  project="${PWD##*/}"
echo "{
	\"folders\":
	[
		{
			\"name\": \"mu-plugins\",
			\"path\": \"/Applications/MAMP/htdocs/$project/wp-content/mu-plugins\"
		},
		{
			\"name\": \"plugins\",
			\"path\": \"/Applications/MAMP/htdocs/$project/wp-content/plugins\"
		},
		{
			\"name\": \"themes/$project\",
			\"path\": \"/Applications/MAMP/htdocs/$project/wp-content/themes/$project\"
		},
		{
			\"name\": \".\",
			\"path\": \"/Applications/MAMP/htdocs/$project/wp-content/\"
		},
		{
			\"name\": \"/\",
			\"path\": \"../../\"
		}
	]
}" > "$project".sublime-project
}

#
# New site creation script. Sets up a new WordPress site in the current directory.
# Usage:
#        `$ mkdir project-name && cd project-name`
#        `$ newsite`
#
function newsite() {
	echo "Downloading WordPress"
	wget https://wordpress.org/latest.tar.gz

	echo "Extracting files"
	tar -xf latest.tar.gz && rm latest.tar.gz
	mv wordpress/* .
	rmdir wordpress

	echo "Removing wp-content folder"
	rm -rf wp-content
	mkdir wp-content
	cd wp-content

	# Prompt for plugin auto load.
	# Good for brand new sites, not good if cloning a wp-content directory.
	read "response?Is this a brand new site or are you cloning a wp-content directory?
	1) Brand new site (add default plugins/theme)
	2) Cloning /wp-content/ (don't add anything)
	"
	case $response in
		1 ) setup_new_site;;
		2 ) setup_cloned_site;;
	esac

	install_wp
}

#
# Handles all the new site setup stuff.
#
function setup_new_site() {
	echo "Brand new site it is!"

	echo "Adding wp-content subfolders"
	mkdir mu-plugins
	mkdir plugins
	mkdir themes
	mkdir uploads

	setup_muplugins
	setup_plugins
	setup_themes
	add_gitignore
}

#
# Handles setup for cloned site.
#
function setup_cloned_site() {
	read "repo?Enter the repo you are cloning (git@yourrepo.com:/reponame.git) (Leave blank to not clone anything.)
	"
	if [ ! -z "$repo" ] ; then
		git clone $repo .
	fi

	cd ..
}

#
# Sets up mu-plugins.
# Downloads the WDS Required Plugins and is_wds_admin mu-plugins.
#
function setup_muplugins() {
	cd mu-plugins
	echo "Downloading WDS Required Plugins"
	wget https://github.com/WebDevStudios/WDS-Required-Plugins/archive/master.zip && unzip master.zip && rm master.zip
	mv WDS-Required-Plugins-master wds-required-plugins

	echo "Downloading is_wds_admin"
	wget https://raw.githubusercontent.com/WebDevStudios/is_wds_admin/master/is-wds-admin.php

	# add any other mu-plugins here

	cd ..

	git add .
	git commit -m "added mu-plugins"
	git push
}

#
# Function to add any plugins that are used on every project.
# Currently just adding Stream.
#
function setup_plugins() {
	cd plugins

	echo "Downloading Stream into plugins"
	wget https://downloads.wordpress.org/plugin/stream.zip && unzip stream.zip && rm stream.zip

  # Optional: Add Migrate DB Pro plugins.
	setup_migratedbpro

	cd ..

	git add .
	git commit -m "added initial plugins"
	git push
}

#
# Add Migrate DB Pro plugins.
# This only works if you have Migrate DB Pro plugins in your MAMP htdocs folder in a folder named /migratedbpro.
# Can omit from setup_plugins() if not using Migrate DB Pro.
#
funciton setup_migratedbpro() {
        echo "Moving MigrateDB Pro files into plugins"
        mkdir wp-migrate-db-pro
        cp -R /Applications/MAMP/htdocs/migratedbpro/wp-migrate-db-pro/* wp-migrate-db-pro
        mkdir wp-migrate-db-pro-cli
        cp -R /Applications/MAMP/htdocs/migratedbpro/wp-migrate-db-pro-cli/* wp-migrate-db-pro-cli
        mkdir wp-migrate-db-pro-media-files
        cp -R /Applications/MAMP/htdocs/migratedbpro/wp-migrate-db-pro-media-files/* wp-migrate-db-pro-media-files
}

#
# Just creates the /themes directory.
# TODO: autogenerate wd_s theme.
#
function setup_themes() {
	cd themes
	# other stuff should be done by fed lead

	cd ..
}

#
# Adds a .gitignore file in the wp-content directory.
#
function add_gitignore() {
	echo "uploads/
blogs.dir/
upgrade/
backup-db/
cache/
backups/
node_modules/
.idea/
# don't ignore the W3 Total Cache /Cache directory!
!plugins/w3-total-cache/lib/W3/Cache
# don't ignore the ThreeWP cache directory either
!plugins/threewp-broadcast/src/cache
.htaccess
.sass-cache
compass_app_log.txt
advanced-cache.php
wp-cache-config.php
sitemap.xml
sitemap.xml.gz
*.log
.DS_Store
.AppleDouble
.LSOverride
plugins/wordpress-importer/
plugins/ajax-thumbnail-rebuild
libbarchart-udt-core-2.3.0-SNAPSHOT.jnilib
themes/twentysixteen" > .gitignore
}

#
# Installs WordPress via WP-CLI.
# Requires WP-CLI is installed and working.
#
function install_wp() {
	project="${PWD##*/}"

	# cd out of wp-content
	cd ..

	wp_manual_install
}

#
# Prompt based WordPress CLI install.
#
function wp_manual_install() {
	project="${PWD##*/}"

	read "db?Enter the db name of the site (e.g. $project)
	"

	echo "Creating wp-config.php and setting up database..."
	wp core config --dbname=$db --dbuser=root --dbpass=root --extra-php <<PHP
/**
 * For developers: WordPress debugging mode.
 *
 * Change this to true to enable the display of notices during development.
 * It is strongly recommended that plugin and theme developers use WP_DEBUG
 * in their development environments.
 *
 * For information on other constants that can be used for debugging,
 * visit the Codex.
 *
 * @link https://codex.wordpress.org/Debugging_in_WordPress
 */
define( 'WP_DEBUG', true );
define( 'WP_DEBUG_LOG', true );
define( 'WP_DEBUG_DISPLAY', true );
define( 'SCRIPT_DEBUG', true );
PHP

	wp db create

	read "url?Enter the url of the site (e.g. $project.dev)
	"

	read "title?Enter the site title (e.g. $project)
	"

	read "email?Enter the admin email for the site (username will be admin and password will be password)
	"

	echo "Now installing WordPress..."
	wp core install --url=$url --title=$title --admin_user=admin --admin_password=password --admin_email=$email
}

function chassis_proj() {
	project="${PWD##*/}"

        echo "Setting up new project folder / file structure for $project..."
        echo "Making misc dirs..."

        mkdir -p "_misc/assets"
        mkdir -p "_misc/backups"
        mkdir -p "_misc/notes"
        mkdir -p "_misc/sublime"

        echo "Creating Chassis sublime project file..."
        hmproj
        mv "$project".sublime-project _misc/sublime/"$project".sublime-project

        echo "Done!"	
}

function hmproj() {

  project="${PWD##*/}"
echo "{
        \"folders\":
        [	
		{
			\"name\": \"tests\",
			\"path\": \"/Users/jazzsequence/hm/$project/content/.tests/tests\"
		},
                {
                        \"name\": \"mu-plugins\",
                        \"path\": \"/Users/jazzsequence/hm/$project/content/mu-plugins\"
                },
                {
                        \"name\": \"plugins\",
                        \"path\": \"/Users/jazzsequence/hm/$project/content/plugins\"
                },
                {
                        \"name\": \"themes/mvp\",
                        \"path\": \"/Users/jazzsequence/hm/$project/content/themes/mvp\"
                },
		{
			\"name\": \"extensions\",
			\"path\": \"/Users/jazzsequence/hm/$project/extensions\"
		},
                {
                        \"name\": \"content\",
                        \"path\": \"/Users/jazzsequence/hm/$project/content/\"
		},
                {
                        \"name\": \"/\",
                        \"path\": \"/Users/jazzsequence/hm/$project/\"
                }
        ]
}" > "$project".sublime-project
}

#
# Set up new site with Chassis
#
function chassis_setup() {
	read "proj?Enter the project name
	"
	
	read "repo?Enter the git repository URL
	"

	echo "Now cloning Chassis into $proj..."
	git clone --recursive https://github.com/Chassis/Chassis $proj
	cd $proj

	echo "Creating project folders..."
	chassis_proj

	if ( '' == $repo ) {
		echo "No repository given, setting up barebones content directory...
		"
		mkdir content
		mkdir content/plugins
		mkdir content/themes
		mkdir content/mu-plugins
		echo "Cloning base theme..."
		git clone git@github.com:humanmade/theme-base.git content/themes/theme-base
	} else {
		echo "Cloning the repository..."
		git clone --recursive $repo content
	}

	echo "Cloning WPCS..."
	git clone --recursive https://github.com/WordPress-Coding-Standards/WordPress-Coding-Standards.git content/.bin/wpcs
	
	echo "Copying Chasis configuration files..."
	cp content/.bin/chassis/* ./

	echo "Installing XDebug..."
	git clone git@github.com:Chassis/Xdebug.git extensions/xdebug

	echo "Installing debugging plugins..."
	git clone git@github.com:Chassis/Debugging.git extensions/debugging

	echo "Installing db-backup extension..."
	git clone https://github.com/Chassis/db-backup extensions/db-backup

	echo "Installing Vagrant hosts updater plugin..."
	vagrant plugin install vagrant-hostsupdater

	echo "Firing up Vagrant box..."
	vagrant up
#
#	echo "SSHing into Vagrant box..."
#	vagrant ssh
#
#	echo "Installing PEAR..."
#	sudo apt-get install php-pear
#
#	echo "Setting up PHPCS..."
#	sudo pear install PHP_CodeSniffer
#	sudo phpcs --config-set installed_paths /vagrant/content/.bin/wpcs
#
#	echo "Doing initial WordPress setup..."
#	wp theme activate mvp
#	wp rewrite structure '/%year%/%monthnum%/%postname%'
#
	echo "Run unit tests like:
	$ vagrant ssh
	$ cd /vagrant/content
	$ phpunit
	
	All done!"
}

##
# Search and replace
#
# Prompts for old/new url and uses WP CLI to perform a search/replace on those urls.
##
function sr() {
	read "old?What's the old URL you want to remove?
	"

	read "new?What's the new url you want to replace it with?
	"

	echo "Perfoming search and replace..."
	if $(wp --url=$old core is-installed --network); then
    		wp search-replace --url=$old '$old' '$new' --recurse-objects --network --path=`$PWD/wp/` 
	else
    		wp search-replace '$old' '$new' --recurse-objects --path=`$PWD/wp/`
	fi
	echo "All done!"
}
